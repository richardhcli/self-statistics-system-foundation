# Changelog - February 2, 2026

## Type Architecture Refactor: Domain Types Migration

**Date**: 2026-02-02  
**Type**: Refactor - Type System Reorganization  
**Impact**: Major structural improvement, zero behavioral changes

### Summary
Comprehensive refactoring of the type system to align with the architecture-lib-vs-stores protocol. Moved domain types (`TextToActionResponse`, `WeightedAction`, `GeneralizationLink`) from feature-specific location to proper domain layer, and consolidated all component props interfaces into the journal types module. This refactor eliminates circular dependencies, improves type reusability, and establishes clear separation between domain logic (`/lib`) and feature implementation (`/features`).

### Changes Made

#### 1. Created `/lib/soulTopology/types.ts`
- **New file**: Domain types for semantic topology system
- **Moved types**: `TextToActionResponse`, `WeightedAction`, `GeneralizationLink`
- **Added**: Comprehensive JSDoc comments with examples and validation rules
- **Rationale**: Domain types belong in `/lib` per architecture protocol (see `architecture-lib-vs-stores.md`)

#### 2. Refactored `/features/journal/types/index.ts`
- **Removed**: Domain types now in `/lib/soulTopology/types.ts`
- **Added**: All component props interfaces from local component files:
  - `JournalFeatureProps`
  - `JournalEntryItemProps`
  - `EntryResultsProps`
  - `ManualEntryFormProps`
  - `VoiceRecorderProps`
  - `JournalViewProps`
- **Enhanced**: Comprehensive JSDoc comments for all interfaces
- **Organized**: Logical grouping (data models vs component props)

#### 3. Updated Import Statements (10 files)
**Library Files:**
- `src/lib/google-ai/utils/single-prompt/text-to-topology.ts`
- `src/lib/soulTopology/utils/entry-pipeline/analyze-entry.ts`
- `src/lib/soulTopology/utils/entry-pipeline/types.ts`
- `src/lib/soulTopology/utils/entry-pipeline/transform-analysis-to-topology.ts`

**Component Files:**
- `src/features/journal/components/journal-entry-item/index.tsx`
- `src/features/journal/components/journal-entry-item/entry-results.tsx`
- `src/features/journal/components/voice-recorder.tsx`
- `src/features/journal/components/manual-entry-form.tsx`
- `src/features/journal/components/journal-view.tsx`
- `src/features/journal/components/journal-feature.tsx`

#### 4. Updated Global Type Exports
- Modified `src/types/index.ts` to export `@/lib/soulTopology/types`

### Architecture Compliance
This refactor adheres to the following documented standards:
- **architecture-lib-vs-stores.md**: Domain models in `/lib`, feature-specific types in `/features`
- **GLOBAL_STATE.md**: Separated Selector Facade Pattern maintained
- **JSDoc Standards**: All interfaces now have comprehensive documentation

### Testing Notes
- ✅ No behavioral changes - pure type reorganization
- ✅ All imports updated atomically
- ✅ TypeScript compilation validates correctness
- ✅ Backward compatibility: No breaking changes to API contracts

### Migration Status
- **Legacy interfaces removed**: All local component interfaces eliminated
- **Centralized type definitions**: Single source of truth established
- **No backward compatibility needed**: Clean migration per rapid prototyping ideology

---

## Journal Entry Schema Refactor: User-Centric Data Model

**Date**: 2026-02-02  
**Type**: Breaking Change - Schema Redesign  
**Impact**: Complete journal entry structure overhaul

### Summary
Transformed journal entry data model from system-centric (generation method) to user-centric (viewing perspective). Unified action weighting for both AI and manual modes, separated performance results from metadata, and introduced explicit flags for entry characteristics. This refactor eliminates legacy fields, simplifies component logic, and establishes a consistent schema across the entire journal system.

### New Schema Structure
```typescript
{
  content: string;                    // Raw entry text
  actions: Record<string, number>;    // Unified: action → weight
  result?: {                          // Performance metrics
    levelsGained: number;
    totalExpIncrease: number;
    nodeIncreases: Record<string, number>;
  };
  metadata: {                         // Entry metadata
    flags: { aiAnalyzed: boolean };
    timePosted: string;
    duration?: string;
  };
}
```

### Key Changes

#### 1. Unified Action Weighting
- **Before**: Separate `weightedActions: WeightedAction[]` and `actions: string[]`
- **After**: Single `actions: Record<string, number>` for both modes
  - AI mode: Semantic weights (e.g., `{ "Debugging": 0.7, "Code review": 0.3 }`)
  - Manual mode: Default weights (e.g., `{ "Exercise": 1, "Reading": 1 }`)

#### 2. Separated Performance Results
- **Before**: Mixed in `metadata: { totalExp, levelsGained, nodeIncreases }`
- **After**: Dedicated `result` object for calculated metrics
- **Rationale**: Clear distinction between entry metadata and performance outcomes

#### 3. Explicit Flags System
- **Before**: Implicit determination via field presence
- **After**: `metadata.flags.aiAnalyzed` boolean
- **Benefit**: Explicit state tracking, extensible for future flags

#### 4. Legacy Fields Removed
- ❌ `weightedActions?: WeightedAction[]` (replaced by `actions` Record)
- ❌ `action?: string` (deprecated singular field)
- ❌ Top-level `duration` (moved to `metadata.duration`)
- ❌ `metadata.totalExp` (renamed to `result.totalExpIncrease`)

### Files Modified (12 total)

**Type Definitions:**
- `features/journal/types/index.ts` - Complete schema redesign

**Core Pipeline:**
- `features/journal/api/create-entry.ts` - Updated loading placeholder
- `hooks/use-entry-orchestrator.ts` - Action weights extraction and result construction
- `lib/soulTopology/utils/entry-pipeline/analyze-entry.ts` - Return actionWeights
- `lib/soulTopology/utils/entry-pipeline/types.ts` - Updated AnalyzeEntryResult

**Components:**
- `features/journal/components/journal-entry-item/index.tsx` - Read new schema
- `features/journal/components/journal-feature.tsx` - Create placeholder with new structure

**Utilities:**
- `features/journal/utils/journal-entry-utils.ts` - Updated XP calculations
- `features/statistics/components/statistics-view.tsx` - Read result.nodeIncreases

### Migration Benefits
1. **Simplified Logic**: Single actions data structure eliminates conditional branching
2. **Type Safety**: Explicit flags prevent ambiguous state
3. **Performance**: Cleaner data model reduces transformation overhead
4. **Extensibility**: Flags system ready for future entry characteristics
5. **User Clarity**: Schema reflects what user sees, not how system generated it

### Testing Status
- ✅ TypeScript compilation passes
- ✅ All components updated to read new schema
- ✅ AI and manual entry modes tested
- ✅ Legacy fields completely removed

---

## Feature Composition: Developer Graph Integration into Debug Console

**Date**: 2026-02-02  
**Type**: Architecture - Feature Composition Refactor  
**Impact**: Navigation structure change, improved feature modularity

### Summary
Implemented the "Slot Pattern" from feature-composition architecture guide to compose the Developer Graph feature into the Debug Console as a subtab. Removed dev-graph from global navigation and established it as a specialized tool within the debug workspace. This refactor eliminates circular dependencies, improves feature cohesion, and demonstrates proper Inversion of Control for feature composition.

### Changes Made

#### 1. Created Debug Subtab System
- **New file**: `src/features/debug/components/debug-tabs.tsx`
- **Tabs**: Console (debug tools) and Graph Editor (developer graph)
- **Pattern**: Local tab state management with slot-based content switching
- **JSDoc**: Comprehensive documentation for DebugTab type and component

#### 2. Refactored DebugView with Slot Pattern
- **Updated**: `src/features/debug/components/debug-view.tsx`
- **Added**: `graphViewSlot: React.ReactNode` prop (composition slot)
- **Structure**: Tabbed interface with console tools and composed graph editor
- **Benefits**: 
  - No direct import of developer-graph feature
  - Maintains feature isolation and vertical slices
  - Extensible for future composed content

#### 3. Updated Composition Root (App)
- **Modified**: `src/app/app.tsx`
- **Change**: Inject `<DeveloperGraphView />` into `<DebugView graphViewSlot={...} />`
- **Location**: App level composition (composition root pattern)
- **JSDoc**: Enhanced documentation explaining composition strategy

#### 4. Removed Dev-Graph from Global Navigation
- **Updated**: `src/components/layout/header.tsx`
- **Removed**: 'dev-graph' from AppView type union
- **Removed**: Dev Graph tab from global navigation menu
- **Result**: Cleaner primary navigation focused on user-facing features

#### 5. Updated Debug Feature Public API
- **Updated**: `src/features/debug/index.ts`
- **Exports**: DebugView, DebugTabs, DebugTab type, test injections
- **Documentation**: JSDoc explaining composition pattern and decoupling strategy

#### 6. Enhanced JSDoc Comments
- **Files**: app.tsx, header.tsx, debug-view.tsx, debug-tabs.tsx, index.ts
- **Standard**: Comprehensive JSDoc for all public interfaces and components
- **Content**: Props descriptions, component responsibilities, architecture rationale

### Architecture Compliance
This refactor implements the following documented patterns:
- **feature-composition.md**: "Slot Pattern" for feature composition
- **Bulletproof React**: Feature-based organization with isolated vertical slices
- **Inversion of Control**: Features composed at app level, not tightly coupled

### File Changes Summary
```
Created:
  + src/features/debug/components/debug-tabs.tsx

Modified:
  ~ src/features/debug/components/debug-view.tsx (slot pattern)
  ~ src/features/debug/index.ts (exports + docs)
  ~ src/app/app.tsx (composition root)
  ~ src/components/layout/header.tsx (removed dev-graph)
  ~ src/lib/db.ts (added deleteDatabase function)

Removed from navigation:
  - 'dev-graph' AppView type
  - Dev Graph global tab
```

### User Experience Changes
- **Before**: Dev Graph accessible from top-level navigation
- **After**: Dev Graph accessible within Debug Console → Graph Editor tab
- **Benefit**: Debug tools consolidated in one feature, cleaner primary navigation

### Testing Notes
- ✅ TypeScript compilation passes
- ✅ Tab switching works correctly
- ✅ Graph editor fully functional within debug console
- ✅ No circular dependencies introduced
- ✅ Feature isolation maintained

### Database Enhancement
- **Added**: `deleteDatabase()` function in `src/lib/db.ts`
- **Purpose**: Complete IndexedDB deletion for factory reset
- **Used by**: Debug console data injection panel's clear/wipe functionality
- **Benefit**: True factory reset that removes entire database, not just clears object stores

---

## Voice Recording: Migration to Batch Transcription with Dual Submission Flows

**Date**: 2026-02-02 (Evening)  
**Type**: Architecture Pivot - Live API → Batch Transcription  
**Impact**: Complete voice recording system rewrite

### Summary
Reverted from Gemini Live API (WebSocket streaming) back to batch transcription approach due to performance concerns. New architecture uses MediaRecorder (WebM) + Web Speech API (display-only preview) + Gemini batch transcription. Introduced dual submission flows: "Record" button for auto-submit (immediate entry creation) and "To Text" button for manual review (populates textarea for editing).

### Key Changes

**DELETED FILES:**
- `src/lib/google-ai/utils/live-transcription.ts` (WebSocket streaming)
- `src/lib/google-ai/utils/audio-processor.ts` (PCM conversion)

**NEW FILES:**
- `src/lib/google-ai/utils/transcribe-webm-audio.ts` (batch Gemini transcription)

**MODIFIED FILES:**
- `src/features/journal/components/voice-recorder.tsx` (complete rewrite)
  * MediaRecorder captures WebM audio (max 60s or manual stop)
  * Web Speech API provides display-only real-time preview (not used for data)
  * Two buttons: "Record" (auto-submit) and "To Text" (manual review)
  * Falls back gracefully if Web Speech API unavailable
  
- `src/features/journal/components/journal-feature.tsx`
  * Added `handleVoiceAutoSubmit()` for immediate entry creation
  * Added `handleVoiceToTextReview()` to populate textarea
  * Added `voiceTranscriptionText` state for manual review flow
  
- `src/features/journal/components/manual-entry-form.tsx`
  * Added `initialText` prop (from voice "To Text")
  * Added `onTextChange` callback for sync with parent
  * Updated placeholder to indicate voice integration
  
- `src/features/journal/types/index.ts`
  * Updated `VoiceRecorderProps` with `onSubmitAuto` and `onToTextReview` callbacks
  * Updated `ManualEntryFormProps` with `initialText` and `onTextChange` props
  
- `src/lib/google-ai/index.ts`
  * Removed `live-transcription` and `audio-processor` exports
  * Added `transcribe-webm-audio` export
  
- `src/lib/google-ai/google-ai-README.md`
  * Removed Live API documentation
  * Added batch transcription documentation with dual flow examples

### User Experience

**Auto-Submit Flow (Record button):**
1. User clicks Record → speaks → clicks Stop
2. Gemini transcribes WebM audio
3. Immediate entry creation with AI processing
4. No manual review required

**Manual Review Flow ("To Text" button):**
1. User clicks Record → speaks → clicks "To Text" (while recording)
2. Gemini transcribes WebM audio
3. Text populates in textarea for review/editing
4. User manually submits when ready

**Web Speech API Preview:**
- Display-only real-time transcription as user speaks
- Greyed out and italicized to indicate "preview" status
- NOT used for submission (only Gemini transcription counts)
- Falls back to silent recording if unavailable

### Technical Details
- Model: `gemini-2.0-flash-exp`
- Audio format: `audio/webm` (MediaRecorder default)
- Max recording: 60 seconds (auto-stops)
- Timeout: 30 seconds for Gemini transcription
- Temperature: 0 (deterministic)

### Build Status
✅ TypeScript compilation succeeds  
✅ Vite build succeeds (700KB bundle)  
✅ No type errors or circular dependencies

---

Refactored manual entry workflows by moving the advanced manual entry form (with action tags and AI toggle) into a new Debug Console tab and simplifying the user-facing journal manual entry to only content + time taken, with AI classification always enabled. Added a dedicated inline TextOnlyManualEntryForm for day-level quick entries that bypasses AI processing entirely, aligning quick logging with manual-only semantics.
