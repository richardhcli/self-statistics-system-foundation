# Change Log â€” 2026-02-07

## Change: massive refactor: journal-architecture-plan

Phase 1 of the Journal refactor is complete: the journal store types are now normalized for the Firebase read-aside model, the ID generator schema is finalized, and feature-level type exports were updated to match the new entry and tree structures. The architecture guidelines were aligned with the hybrid read-aside philosophy to reflect Firebase as the source of truth with Zustand/IndexedDB as cache.

Phase 2 is complete: the Firebase journal service layer now implements tree subscriptions, month-range entry fetches using document ID prefixes, and batch write helpers for entry and tree updates.

Phase 3 is complete: the journal store now uses a normalized entry map with a lightweight tree index, cache metadata for TTL checks, and Firebase-backed month fetching, with UI components updated to read from the new tree + entry cache shape.

Phase 4 is complete: the unified journal entry pipeline now handles draft creation, transcription, AI analysis, and Firebase updates; legacy create-entry and voice orchestration hooks were removed to enforce the new pipeline.

A new CDAG topology read-aside migration plan was added, outlining how the graph store will move to Firebase once the journal refactor is fully stabilized.

Phase 5 and Phase 6 are complete: cache-aware UI fetching is wired into JournalView, and a migration utility now wipes legacy journal cache keys on boot.

Journal feature documentation was refreshed for the unified pipeline and read-aside storage model in documentation/docs-features/journal.

## Change: AI Pipeline Stability Refactor

Significant improvements were made to the Gemini 3 AI pipeline to resolve timeout issues and invalid model references.

1.  **Prompt Optimization**: The `stuffed-prompt.ts` was aggressively condensed to reduce token usage and improve response times.
2.  **Prompt Injection Safety**: Fixed a critical bug where manual journal entries containing special characters (quotes/newlines) broke the prompt structure. Code now uses explicit `JSON.stringify()` serialization.
3.  **Model Fallback Strategy**: Implemented adaptive fallback logic in both the Topology pipeline (`text-to-topology.ts`) and Voice Transcription (`transcribe-webm-audio.ts`). The system now attempts `gemini-3-flash-preview` first and automatically falls back to `gemini-2.0-flash` on failure/timeout.
4.  **Timeout Tuning**: Reduced single-request timeouts from 120s to 45s (30s for voice) to ensure fallbacks trigger quickly without leaving the user hanging.
5.  **Error Handling**: Added robust try/catch blocks in the manual entry pipeline to catch and display AI failures properly within the UI (via `ANALYSIS_FAILED` status).
